version: 2.1
orbs:
  tech-docs: ktech/tech-docs@1
  bandstand: ktech/bandstand@2

main_branch_only: &main_branch_only
  branches:
    only:
      - /^main$/

workflows:
  version: 2
  main:
    jobs:
      - tech-docs/publish-docs:
          name: publish-docs-backstage-test
          env: test
          context:
            - aws-base
            - bandstand-test
      - tech-docs/publish-docs:
          name: publish-docs-backstage-prod
          env: prod
          filters: *main_branch_only
          context:
            - aws-base
            - bandstand-prod
      - bandstand/install-chart:
          matrix:
            chart:
              - tests/cron-job-defaults
              - tests/web-service-defaults
              - tests/test-runner-defaults
          name: test-chart-<<matrix.chart>>
          namespace: lab
          values: ./<<matrix.chart>>/values.yaml
          values-to-override: "image.tag=sha-${CIRCLE_SHA1}"
          dry-run: true
          context:
            - aws-base
            - bandstand-<<matrix.environment>>
