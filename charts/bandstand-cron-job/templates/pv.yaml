{{- if and .Values.volume .Values.volume.s3Volume (default false .Values.volume.s3Volume.enabled) }}
{{- $relName := .Release.Name -}}
{{- if .Values.volume.nameSuffix }}
{{- $relName = print .Release.Name "-" .Values.volume.nameSuffix }}
{{- end }}
apiVersion: v1
kind: PersistentVolume
metadata:
  name: {{ .Values.volume.pvName | default (print $relName "-pv") }}
  labels:
    {{- include "bandstand-cron-job.labels" . | nindent 4 }}
spec:
  capacity:
    storage: {{ .Values.volume.persistent | default "5Gi" }}
  volumeMode: Filesystem
  accessModes:
    - ReadOnlyMany
  persistentVolumeReclaimPolicy: Retain
  csi:
    driver: s3.csi.aws.com
    volumeHandle: {{ .Values.volume.volumeHandle | default (print "s3-" $relName "-volume") }}
    volumeAttributes:
      bucketName: {{ required "s3Volume.bucketName is required" .Values.s3Volume.bucketName }}
      prefix: {{ required "s3Volume.prefix is required" .Values.s3Volume.prefix }}
      authenticationSource: {{ .Values.s3Volume.authenticationSource | default "pod" }}
  claimRef:
    namespace: {{ .Release.Namespace }}
    name: {{ .Values.volume.pvcName | default $relName }}
{{- end }}
