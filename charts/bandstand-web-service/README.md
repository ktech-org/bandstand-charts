# Bandstand web service

## Global values

| Key                | Type   | Default | Description                                           |
|--------------------|--------|---------|-------------------------------------------------------|
| global.aws.account | string |         | The AWS account the helm chart is installed into      |
| global.env         | string |         | The environment, either test, preprod or prod         |
| global.image.tag   | string |         | The tag for container image to be used in the service |

## Values

| Key                                 | Type   | Default                                                       | Description                                                                                                                                                                                                                                                                                                |
|-------------------------------------|--------|---------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| additionalDomains                   | list   | `[]`                                                          | A list of additional domains for the service                                                                                                                                                                                                                                                               |
| additionalEnvVars                   | object | `{}`                                                          | An object containing additional environment variables                                                                                                                                                                                                                                                      |
| advancedScaling.enabled             | bool   | `false`                                                       | Enable advanced scaling options, must be set to `true` if `hpa.enabled` is set to `false`. Also see the notes on migrating to advanced scaling in the [README](../../docs/README.md).                                                                                                                      |
| advancedScaling.scalers             | list   | `[]`                                                          | List of scalers to apply. Types include `cron`, `cpu`, `memory`, `kafka`. For examples usage see [here](https://github.com/ktech-org/bandstand-charts/blob/main/test-charts/web-service/advanced-scaling/values.yaml)                                                                                      |
| advancedScaling.cooldown            | bool   | `60`                                                          | Minimum time to wait before scaling back down to zero again (e.g. if no offset on kafka topic).                                                                                                                                                                                                            |
| advancedScaling.maxReplicas         | int    | `3`                                                           | Maximum replicas to run                                                                                                                                                                                                                                                                                    |
| advancedScaling.minReplicas         | int    | `1`                                                           | Minimum replicas to run when service is active (e.g. messages to process)                                                                                                                                                                                                                                  |
| advancedScaling.idleReplicas        | int    | `0`                                                           | Number of replicas when service not active (e.g. has no messages to process)                                                                                                                                                                                                                               |
| environmentEnvVars                  | object | `{}`                                                          | An object containing environment specific additional environment variables                                                                                                                                                                                                                                 |
| containerPort                       | int    | `8080`                                                        | The port to open on the container for the service                                                                                                                                                                                                                                                          |
| dockerRegistry                      | string | `067805054192.dkr.ecr.eu-west-1.amazonaws.com`                              | Docker registry to pull images from (ECR in ktech-ops)                                                                                                                                                                                                                                                                       |
| enforceCpuLimits                    | bool   |                                                               | By default CPU will burst to use spare capacity on the node. Setting this flag will add a cpu limit with the same value as `resources.requests.cpu`. It is recommended to set this flag in performance testing environments to ensure recorded performance isn't based on unallocated capacity             |
| envFrom                             | object | `{}`                                                          | References to ConfigMaps / Secrets which will be mapped to environment variables. For more details see [here](https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/#configure-all-key-value-pairs-in-a-configmap-as-container-environment-variables)                           |
| gitRepo                             | string | `.Release.Name`                                               | The name of the repository for the service                                                                                                                                                                                                                                                                 |
| hpa.enabled                         | int    | `true`                                                        | Enable/disable the Horizontal Pod AutoScaler. Must be set to `false` if `advancedScaling` is enabled                                                                                                                                                                                                       |
| hpa.averageCpuUtilization           | int    | `50`                                                          | Horizontal pod autoscaler, the threshold average CPU ultilization to trigger, see [here](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/)                                                                                                                                       |
| hpa.maxReplicas                     | int    | `3`                                                           | Horizontal pod autoscaler, maximum number of pods, see [here](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/)                                                                                                                                                                  |
| hpa.minReplicas                     | int    | `1`                                                           | Horizontal pod autoscaler, minimum number of pods, see [here](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/)                                                                                                                                                                  |
| imageName                           | string | `.Release.Name "-" .Values.nameSuffix`                        | Name of the docker image to run                                                                                                                                                                                                                                                                            |
| imagePullSecret                     | string | `rt-docker-config`                                            | Docker registry secret for pulling image                                                                                                                                                                                                                                                                   |
| ingress.annotations                 | object | `{}`                                                          | Additional annotations to apply to the ingress object                                                                                                                                                                                                                                                      |
| ingress.domain                      | string |                                                               | Primary ingress domain for service, normally ktech.com                                                                                                                                                                                                                                                     |
| ingress.enabled                     | bool   |                                                               | True if the service has an ingress                                                                                                                                                                                                                                                                         |
| ingress.visibility                  | string |                                                               | Whether service is externally visible, either cluster, private or public                                                                                                                                                                                                                                   |
| ingress.defaultBackend              | string | `.Release.Name`                                               | The name of the service to host at the `/` path                                                                                                                                                                                                                                                            |
| ingress.additionalPaths             | string | `.Release.Name`                                               | Additional path rules to apply to the ingress host, see [here](https://kubernetes.io/docs/concepts/services-networking/ingress/#the-ingress-resource) and [here](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#httpingresspath-v1-networking-k8s-io)                                |                                                                                                                                                                                                                                      |
| kafka.bootstrapServersEnvVar                  | string | `KAFKA_BROKERS`                                                           | Comma separated list of Kafka brokers `hostname:port` to connect to for bootstrap.                                                                                                                                                                                                                                        |
| kafka.consumerGroup                  | string |                                                            | Name of the consumer group used for checking the offset on the topic and processing the related lag.                                                                                                                                                                                                                                        |
| kafka.topic                  | string |                                                            | Name of the topic on which processing the offset lag. lag.                                                                                                                                                                                                                                        |
| kafka.tls                  | string | `enable`                                                           | SSL auth for Kafka is enabled by default. If set to `disable` TLS for Kafka is not used.                                                                                                                                                                                                                                        |
| livenessProbe.path                  | string | `/`                                                           | Path to the endpoint used to determine whether a container is active 
| nameSuffix                          | string |                                                               | A suffix to be appended to the name of all created resources. This is useful when using subcharts to define multiple services within a single helm release                                                                                                                                                 |
| owner                               | string |                                                               | The GitHub team that owns the service                                                                                                                                                                                                                                                                      |
| config                              | object | `{}`                                                          | An object containing base config for the service - use this for creating base config files.                                                                                                                                                                                                                |
| envConfig                           | object | `{}`                                                          | An object containing environment config for the service - use this for creating environment specific config files.                                                                                                                                                                                         |
| preStopWait.proxy                   | number |                                                               | The time in seconds to wait for the linkerd proxy to drain connections before the container is stopped.                                                                                                                                                                                                    |
| preStopWait.service                 | number |                                                               | The time in seconds to wait for the service to drain connections before the container is stopped.                                                                                                                                                                                                          |
| readinessProbe.path                 | string | `/`                                                           | Path to the endpoint used to determine whether a container is ready                                                                                                                                                                                                                                        |
| reloader.enabled                    | bool | `true`                                                           | When set to true, instructs Reloader to track and reload the application when related ConfigMaps or Secrets change. When set to false, no automatic Pod restarts occur on ConfigMap or Secret updates.                                                                                                                                                                                                                                        |
| resources.requests.linkerd.memory   | string | ``                                                            | Override linkerd-proxy container memory [Requests and Limit](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#requests-and-limits) see [here](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#meaning-of-memory) (both set to the same value) |
| resources.requests.ephemeralStorage | string | `64Mi`                                                        | Container ephemeral storage [Requests and Limit](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#requests-and-limits) see [here](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#local-ephemeral-storage) (both set to the same value)       |  
| resources.requests.cpu              | string | `100m`                                                        | [Requests](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#requests-and-limits) for container CPU resources measured in cpu units, one core is 1000m, see [here](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#meaning-of-cpu)             |
| resources.requests.memory           | string | `512Mi`                                                       | Container memory [Requests and Limit](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#requests-and-limits) see [here](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#meaning-of-memory) (both set to the same value)                        |
| resources.requests.ephemeralStorage | string | `64Mi`                                                        | Container ephemeral storage [Requests and Limit](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#requests-and-limits) see [here](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#local-ephemeral-storage) (both set to the same value)       |
| runAsUser                           | number | `1000`                                                        | The user id to run the container as (cannot be 0/root)                                                                                                                                                                                                                                                     |
| secrets                             | list   | `[]`                                                          | List of secrets manager secrets to add to the pod (via External Secrets). For details of each entries attributes see below. See [the handbook](https://engineering-handbook.ktech.com/core-infrastructure/bandstand/development/secrets/) for usage examples.                                              |
| secrets[].name                      | string |                                                               | The name of the entry, will be used as part of the secret name.                                                                                                                                                                                                                                            |
| secrets[].secret                    | string |                                                               | The name of the secrets manager secret to sync. Note this field can include references to other values e.g. `{{.Values.global.env}}`                                                                                                                                                                       |
| secrets[].prefix                    | string |                                                               | An optional prefix added to all envvar names coming from this secret.                                                                                                                                                                                                                                      |
| secrets[].optional                  | bool   | `false`                                                       | Flag to indicate if adding this secret to the env is optional or not. If this is set to `false` (the default) and the secret fails to sync due to a misconfiguration or missing secret value, then the pods won't attempt to start.                                                                        |
| secrets[].upperCaseKeys             | bool   | `false`                                                       | Flag to indicate if keys should be transformed to be upper case.                                                                                                                                                                                                                                           |
| serverContainer.arguments           | list   |                                                               | Override the default container (Helm) arguments (this is the docker CMD) for the service Pod                                                                                                                                                                                                               |
| serverContainer.command             | string |                                                               | Override the default container (Helm) command (this is the docker ENTRYPOINT) for the service Pod                                                                                                                                                                                                          |
| systemCode                          | string | `.Release.Name`                                               | The systemCode for the service                                                                                                                                                                                                                                                                             |
| systemGroup                         | string |                                                               | The systemGroup for the service                                                                                                                                                                                                                                                                            |
| terminationGracePeriodSeconds       | number | `30`                                                          | The time in seconds to wait for the pod to terminate gracefully                                                                                                                                                                                                                                            |
| test.additionalEnvVars              | object | `{}`                                                          | An object containing additional environment variables. Use these in the values.yaml file.                                                                                                                                                                                                                  |
| test.environmentEnvVars             | object | `{}`                                                          | An object containing environment specific additional environment variables. Use this in *-values.yaml files to not overwrite the additionalEnvVars object                                                                                                                                                  |
| test.envFrom                        | object | `{}`                                                          | References to ConfigMaps / Secrets which will be mapped to environment variables on test containers. For more details see [here](https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/#configure-all-key-value-pairs-in-a-configmap-as-container-environment-variables)        |
| test.createServiceAccount           | bool   |                                                               | Set to true to create a dedicated service account - `<rel-name>-acceptances-tests` for the test pods. Will also require terraforming a corresponding service-role in order to grant any required IAM permissions.                                                                                          |
| test.resources.requests.memory      | string | `512Mi`                                                       | Test container memory                                                                                                                                                                                                                                                                                      |
| test.imageName                      | string | `.Values.imageName` or `.Release.Name "-" .Values.nameSuffix` | Name of the docker image to run                                                                                                                                                                                                                                                                            |
| test.secrets                        | list   | `[]`                                                          | List of secrets manager secrets to add to the test pod (via External Secrets). For details of each entries attributes see below. See [the handbook](https://engineering-handbook.ktech.com/core-infrastructure/bandstand/development/secrets/) for usage examples.                                         |
| test.secrets[].name                 | string |                                                               | The name of the entry, will be used as part of the secret name.                                                                                                                                                                                                                                            |
| test.secrets[].secret               | string |                                                               | The name of the secrets manager secret to sync. Note this field can include references to other values e.g. `{{.Values.global.env}}`                                                                                                                                                                       |
| test.secrets[].prefix               | string |                                                               | An optional prefix added to all envvar names coming from this secret.                                                                                                                                                                                                                                      |
| test.secrets[].optional             | bool   | `false`                                                       | Flag to indicate if adding this secret to the env is optional or not. If this is set to `false` (the default) and the secret fails to sync due to a misconfiguration or missing secret value, then the pods won't attempt to start.                                                                        |
| test.secrets[].upperCaseKeys        | bool   | `false`                                                       | Flag to indicate if keys should be transformed to be upper case.                                                                                                                                                                                                                                           |
| testContainer.arguments             | list   |                                                               | Override the default container (Helm) arguments (this is the docker CMD) for the test Pod                                                                                                                                                                                                                  |
| testContainer.command               | string |                                                               | Override the default container (Helm) command (this is the docker ENTRYPOINT) for the test Pod                                                                                                                                                                                                             |
| volume.persistent                   | string |                                                               | Adds a persistent volume of the amount set, e.g. 1G                                                                                                                                                                                                                                                        |
| volume.ephemeral                    | string |                                                               | Size of ephemeral storage, e.g. 10G mounted at /tmp standard emptyfile tmp directory added if not set.    