{{- define "service-library.tests.pod" -}}
apiVersion: v1
kind: Pod
metadata:
  name: {{ .Release.Name }}-acceptance-tests
  labels: {{- include "service-library.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
    "polaris.fairwinds.com/readinessProbeMissing-exempt": true
    "polaris.fairwinds.com/livenessProbeMissing-exempt": true
spec:
  containers:
    - name: {{ .Release.Name }}-acceptance-tests
      image: 067805054192.dkr.ecr.eu-west-1.amazonaws.com/{{ .Release.Name }}-acceptance-tests:{{ .Values.image.tag }}
      imagePullPolicy: Always
      resources:
        requests:
          cpu: 250m
          memory: 250Mi
        limits:
          cpu: 500m
          memory: 750Mi
      env:
        - name: ENV
          value: {{ .Values.env }}
      volumeMounts:
        - name: workspace
          mountPath: /tmp/workspace
          readOnly: false
      securityContext:
        runAsNonRoot: true
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        capabilities:
          drop:
            - all
  volumes:
    - name: workspace
      emptyDir: { }
  securityContext:
    runAsUser: 1000
  restartPolicy: Never
{{- end }}
